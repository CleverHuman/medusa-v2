version: '3.8'
name: medusa_dev
services:
  mysql:
    build:
      context: ../mysql  # Dockerfile 所在目录
    container_name: medusa-mysql-dev
    env_file: .env.dev
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: medusa
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    networks:
      app-net:
        ipv4_address: 172.30.0.2
    healthcheck:  # 健康检查确保依赖服务就绪[3,8](@ref)
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - ../data/mysql:/var/lib/mysql

  redis:
    image: redis:7.0-alpine
    container_name: medusa-redis-dev
    env_file: .env.dev
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
    command: redis-server --requirepass ${REDIS_PASSWORD}
    networks:
      app-net:
        ipv4_address: 172.30.0.3
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
    volumes:
      - ../data/redis:/data
#      - type: bind
#        source: ../data/redis
#        target: /data

  api:
    build:
      context: ../../medusa-admin
      dockerfile: Dockerfile
      args:
        ENV: dev  # 明确指定环境
    container_name: medusa-api-dev
    env_file: .env.dev
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      HTTP_PROXY: socks5h://tor:9050
      HTTPS_PROXY: socks5h://tor:9050
      NO_PROXY: localhost,127.0.0.1,mysql,redis,nginx
      SPRING_PROFILES_ACTIVE: druid
      SPRING_FLYWAY_PATH: dev
      SPRING_DATASOURCE_URL: ${DB_HOST}
      SPRING_DATASOURCE_USERNAME: ${DB_USER}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      SPRING_DATASOURCE_ROOTPASSWORD: ${DB_ROOT_PASSWORD}
      SPRING_REDIS_HOST: ${REDIS_HOST}
      SPRING_REDIS_PASSWORD: ${REDIS_PASSWORD}
      BTCPAY_URL: ${BTCPAY_URL}
      BTCPAY_API_KEY : ${BTCPAY_API_KEY}
      BTCPAY_STORE_ID : ${BTCPAY_STORE_ID}
      NOWPAYMENTS_API_KEY: ${NOWPAYMENTS_API_KEY}

#    ports:
#      - "8080:8080"
    networks:
      app-net:
        ipv4_address: 172.30.0.4
    restart: unless-stopped
    volumes:
      - /var/log/medusa-api:/var/log/medusa-api
      - ../data/medusa-api/uploadPath:/home/medusa-api/uploadPath

  nginx:
    build:
      context: ../../  # 将上下文设置为项目根目录
      dockerfile: docker/nginx/Dockerfile  # 显式指定 Dockerfile 路径
      args:
        ENV: dev  # 明确指定环境
    container_name: medusa-nginx-dev
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"
#    ports:
#      - "127.0.0.1:8080:80"
    networks:
      app-net:
        ipv4_address: 172.30.0.20  # 固定IP，Tor隐藏服务指向此地址
    restart: unless-stopped

networks:
  app-net:
    external: true
    name: app-net  # ✅ 关键修正