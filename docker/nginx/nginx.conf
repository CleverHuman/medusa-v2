worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    server {
        listen       80;
        server_name  localhost;
		charset utf-8;

        # ============================================
        # 静态资源代理 - 必须在 location / 之前配置
        # 使用最长匹配优先规则，确保静态资源正确代理
        # ============================================
        
        # Vendor Portal 静态资源（JS/CSS）- 代理到后端Spring Boot
        location /vendor/ {
          proxy_pass http://api:8080/vendor/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          
          # 添加超时设置
          proxy_connect_timeout 30s;
          proxy_send_timeout 30s;
          proxy_read_timeout 30s;
        }

        # 通用静态资源 - 代理到后端Spring Boot
        location /static/ {
          proxy_pass http://api:8080/static/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          
          # 添加超时设置
          proxy_connect_timeout 30s;
          proxy_send_timeout 30s;
          proxy_read_timeout 30s;
        }

        # ============================================
        # API 代理 - 必须在静态文件 location 之前
        # ============================================
        
        # 所有 /api/ 请求代理到后端（包括 /api/mall/vendor/...）
        location /api/ {
          proxy_pass http://api:8080/api/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          
          # 添加错误处理和超时设置
          proxy_connect_timeout 60s;
          proxy_send_timeout 60s;
          proxy_read_timeout 60s;
          proxy_buffering off;
          
          # 传递后端错误信息（不拦截错误，让后端错误直接返回）
          proxy_intercept_errors off;
          
          # 添加请求体大小限制
          client_max_body_size 10M;
        }

        # ============================================
        # 静态文件服务 - 精确匹配，不匹配子路径
        # ============================================
        
        # 精确匹配 /api/mall，重定向到带斜杠的版本
        location = /api/mall {
            return 301 /api/mall/;
        }

        # 精确匹配 /api/mall/，用于前端静态文件首页
        location = /api/mall/ {
            alias   /usr/share/nginx/html/mall/;
            try_files $uri $uri/ /api/mall/index.html;
            index index.html index.htm;
        }

        # 精确匹配 /api/mall/index.html
        location = /api/mall/index.html {
            alias   /usr/share/nginx/html/mall/index.html;
        }

        # ============================================
        # 其他代理配置
        # ============================================
        
        # 修复后端代理地址：使用服务名 api 替代 localhost
        location /prod-api/ {
          proxy_pass http://api:8080/;  # 关键修改：api 是 docker-compose 中的服务名
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /mall/ {
          proxy_pass http://api:8080/mall/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          
          # 添加超时设置
          proxy_connect_timeout 60s;
          proxy_send_timeout 60s;
          proxy_read_timeout 60s;
        }

		location /admin {
            alias   /usr/share/nginx/html/admin/;
        	try_files $uri $uri/ /admin/index.html;
        	index  index.html index.htm;
        }

        # ============================================
        # 默认重定向 - 必须在最后（匹配所有其他路径）
        # ============================================
        location / {
          return 302 /mall/static/home;  # 如需永久改 301
        }

         location /profile/ {
                  proxy_pass http://api:8080/profile/;
          }
      }
}
