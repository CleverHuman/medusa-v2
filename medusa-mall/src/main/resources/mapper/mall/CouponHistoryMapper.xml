<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.medusa.mall.mapper.CouponHistoryMapper">

    <resultMap id="CouponHistoryResultMap" type="com.medusa.mall.domain.coupon.CouponHistory">
        <id property="id" column="id"/>
        <result property="couponId" column="coupon_id"/>
        <result property="memberId" column="member_id"/>
        <result property="orderId" column="order_id"/>
        <result property="orderSn" column="order_sn"/>
        <result property="useStatus" column="use_status"/>
        <result property="useTime" column="use_time"/>
        <result property="createBy" column="create_by"/>
        <result property="createTime" column="create_time"/>
        <result property="updateBy" column="update_by"/>
        <result property="updateTime" column="update_time"/>
        <result property="remark" column="remark"/>
    </resultMap>

    <select id="selectCouponHistoryById" resultMap="CouponHistoryResultMap">
        SELECT * FROM mall_coupon_history WHERE id = #{id}
    </select>

    <select id="selectCouponHistoryList" resultMap="CouponHistoryResultMap">
        SELECT * FROM mall_coupon_history
        <where>
            <if test="couponId != null">
                AND coupon_id = #{couponId}
            </if>
            <if test="memberId != null">
                AND member_id = #{memberId}
            </if>
            <if test="useStatus != null">
                AND use_status = #{useStatus}
            </if>
        </where>
        ORDER BY create_time DESC
    </select>

    <insert id="insertCouponHistory" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO mall_coupon_history
        (coupon_id, member_id, order_id, order_sn, use_status, use_time,
         create_by, create_time, update_by, update_time, remark)
        VALUES
            (#{couponId}, #{memberId}, #{orderId}, #{orderSn}, #{useStatus}, #{useTime},
             #{createBy}, #{createTime}, #{updateBy}, #{updateTime}, #{remark})
    </insert>

    <update id="updateCouponHistory">
        UPDATE mall_coupon_history
        SET coupon_id = #{couponId},
            member_id = #{memberId},
            order_id = #{orderId},
            order_sn = #{orderSn},
            use_status = #{useStatus},
            use_time = #{useTime},
            update_by = #{updateBy},
            update_time = #{updateTime},
            remark = #{remark}
        WHERE id = #{id}
    </update>

    <delete id="deleteCouponHistoryById">
        DELETE FROM mall_coupon_history WHERE id = #{id}
    </delete>

    <delete id="deleteCouponHistoryByIds">
        DELETE FROM mall_coupon_history
        WHERE id IN
        <foreach collection="array" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 新增：计数接口用于避免重复恢复（幂等） -->
    <select id="countByCouponOrderAndStatus" resultType="int">
        SELECT COUNT(1)
        FROM mall_coupon_history
        WHERE coupon_id = #{couponId}
          AND order_id = #{orderId}
          AND use_status = #{useStatus}
    </select>

</mapper>
