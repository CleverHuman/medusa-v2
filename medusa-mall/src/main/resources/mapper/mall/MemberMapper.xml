<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.medusa.mall.mapper.MemberMapper">


    <!-- 基础Member结果映射 -->
    <resultMap id="MemberResult" type="Member">
        <id     property="memberId"       column="member_id"      />
        <result property="username"       column="username"       />
        <result property="password"       column="password"       />
        <result property="primaryContact" column="primary_contact"/>
        <result property="secondaryContact" column="secondary_contact"/>
        <result property="tgId"           column="tg_id"          />
        <result property="tgUsername"           column="tg_username"          />
        <result property="sourceType"     column="source_type"    />
        <result property="status"         column="status"         />
        <result property="linkedAccount"  column="linked_account" />
        <result property="createBy"       column="create_by"      />
        <result property="createTime"     column="create_time"    />
        <result property="updateBy"       column="update_by"      />
        <result property="updateTime"     column="update_time"    />
        <result property="remark"         column="remark"         />
    </resultMap>


    <resultMap id="MemberInfoResult" type="MemberInfo">
        <id     property="memberId"       column="member_id"      />
        <result property="username"      column="username"     />
        <result property="primaryContact" column="primary_contact"/>
        <result property="secondaryContact" column="secondary_contact"/>
        <result property="tgId"           column="tg_id"          />
        <result property="tgUsername"           column="tg_username"          />
        <result property="sourceType"     column="source_type"    />
        <result property="status"         column="status"         />
        <result property="createTime"      column="create_time" />
         <result property="remark"         column="remark"         />  <!-- 添加这一行 -->
        <result property="totalOrders"      column="total_orders" />
        <result property="currentLevel" column="current_level" />
        <result property="currentPoint"    column="current_point"   />
        <result property="currentAud"     column="current_aud"    />
        <result property="lastLevel"     column="last_level"    />
        <result property="lastPoint"       column="last_point"      />
        <result property="lastAud"       column="last_aud"      />
        <!-- 新增字段映射 -->
        <result property="lastSourceType" column="last_source_type" />
        <result property="lastSeen"      column="last_seen" />
        <!-- 折扣字段映射 -->
        <result property="fixDiscount"   column="fixed_discount" />
        <result property="percentDiscount" column="percent_discount" />
        <result property="shippingDiscount" column="shipping_discount" />
        <!-- 等级名称映射 -->
        <result property="levelName"     column="level_name" />
        <!-- 等级描述映射 -->
        <result property="des"           column="des" />
        <!-- 关联账号映射 -->
        <result property="linkedAccount" column="linked_account" />
        <result property="linkedAccountUsername" column="linked_account_username" />
    </resultMap>


    <resultMap type="MemberLoginInfo" id="MemberLoginInfoResult">
        <id property="infoId" column="info_id" />
        <result property="memberId" column="member_id" />
        <result property="sourceType" column="source_type" />
        <result property="msg" column="msg" />
        <result property="createTime"     column="create_time"     />
    </resultMap>

    <!-- 通用查询字段 -->
    <sql id="selectMemberInfoVo">
        SELECT
        m.member_id,
        m.username,
        m.primary_contact,
        m.secondary_contact,
        m.tg_id,
        m.tg_username,
        m.source_type,
        m.status,
        m.create_time,
        m.remark,  <!-- 添加这一行 -->
        m.linked_account,
        linked.username AS linked_account_username,
        l.total_orders,
        l.current_level,
        l.current_point,
        l.current_aud,
        l.last_level,
        l.last_point,
        l.last_aud,
        i.source_type AS last_source_type,
        i.create_time AS last_seen,
        mb.fixed_discount,
        mb.percent_discount,
        mb.shipping_discount,
        mb.level_name,
        mb.des
        FROM mall_member m
        INNER JOIN mall_member_level l ON m.member_id = l.member_id
        INNER JOIN (
        -- 子查询：获取每个用户的最新登录记录（info_id 最大）
        SELECT member_id, source_type, create_time
        FROM mall_member_login_info
        WHERE (member_id, info_id) IN (
        SELECT member_id, MAX(info_id)
        FROM mall_member_login_info
        GROUP BY member_id
        )
        ) i ON m.member_id = i.member_id
        LEFT JOIN mall_member_benefit mb ON l.current_level = mb.level_id
        LEFT JOIN mall_member linked ON m.linked_account = linked.member_id
    </sql>



    <select id="checkUsernameUnique" parameterType="String" resultMap="MemberResult">
        select member_id, username from mall_member where username = #{username} limit 1
    </select>


    <select id="checkTgIdUnique" parameterType="String" resultMap="MemberResult">
        select member_id, tg_id from mall_member where tg_id = #{tgId} limit 1
    </select>

    <select id="selectMemberByUsername" parameterType="String" resultMap="MemberResult">
        select * from mall_member where username = #{username}
    </select>

    <select id="selectMemberByTgId" parameterType="String" resultMap="MemberResult">
        select * from mall_member where tg_id = #{tgId}
    </select>


    <insert id="insertMember" parameterType="Member" useGeneratedKeys="true" keyProperty="memberId">
        insert into mall_member(
            <if test="username != null and username != ''">username,</if>
            <if test="password != null and password != ''">password,</if>
            <if test="primaryContact != null and primaryContact != ''">primary_contact,</if>
            <if test="secondaryContact != null and secondaryContact != ''">secondary_contact,</if>
            <if test="tgId != null and tgId != ''">tg_id,</if>
            <if test="tgUsername != null and tgUsername != ''">tg_username,</if>
            <if test="sourceType != null and sourceType != ''">source_type,</if>
            <if test="createBy != null and createBy != ''">create_by,</if>
            <if test="remark != null and remark != ''">remark,</if>
            create_time
        )values(
            <if test="username != null and username != ''">#{username},</if>
            <if test="password != null and password != ''">#{password},</if>
            <if test="primaryContact != null and primaryContact != ''">#{primaryContact},</if>
            <if test="secondaryContact != null and secondaryContact != ''">#{secondaryContact},</if>
            <if test="tgId != null and tgId != ''">#{tgId},</if>
            <if test="tgUsername != null and tgUsername != ''">#{tgUsername},</if>
            <if test="sourceType != null and sourceType != ''">#{sourceType},</if>
            <if test="createBy != null and createBy != ''">#{createBy},</if>
            <if test="remark != null and remark != ''">#{remark},</if>
        sysdate()
        )
    </insert>

    <update id="updateMember" parameterType="Member">
        update mall_member
        <set>
            <if test="username != null and username != ''">username = #{username},</if>
            <if test="password != null and password != ''">password = #{password},</if>
            <if test="status != null and status != ''">status = #{status},</if>
            <if test="updateBy != null and updateBy != ''">update_by = #{updateBy},</if>
            <if test="remark != null">remark = #{remark},</if>
            update_time = sysdate()
        </set>
        where member_id = #{memberId}
    </update>


    <select id="selectMemberList" parameterType="MemberInfo" resultMap="MemberInfoResult">
        <include refid="selectMemberInfoVo" />
        WHERE 1=1
        <if test="currentLevel != null">
            AND l.current_level = #{currentLevel}
        </if>
        
        <if test="username != null and username != ''">
            AND m.username like concat('%', #{username}, '%')
        </if>

        <if test="primaryContact != null and primaryContact != ''">
            AND m.primary_contact like concat('%', #{primaryContact}, '%')
        </if>

        <if test="secondaryContact != null and secondaryContact != ''">
            AND m.secondary_contact like concat('%', #{secondaryContact}, '%')
        </if>

        <if test="status != null and status !=''">
            AND m.status = #{status}
        </if>
        
        <if test="params.beginTime != null and params.beginTime != ''"><!-- 开始时间检索 -->
            AND create_time &gt;= #{params.beginTime}
        </if>
        <if test="params.endTime != null and params.endTime != ''"><!-- 结束时间检索 -->
            AND create_time &lt;= #{params.endTime}
        </if>
        ORDER BY i.create_time DESC
    </select>

    <!-- 根据ID查询会员详细信息 -->
    <select id="selectMemberInfoById" parameterType="Long" resultMap="MemberInfoResult">
        <include refid="selectMemberInfoVo"/>
        WHERE m.member_id = #{memberId}
    </select>

    <update id="updateMemberStatusByIds" parameterType="map">
        UPDATE mall_member
        SET status = #{status}
        WHERE member_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 硬删除会员（物理删除） -->
    <delete id="deleteMemberByIds">
        DELETE FROM mall_member
        WHERE member_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 更新会员备注 -->
    <update id="updateMemberRemark" parameterType="Member">
        UPDATE mall_member
        SET remark = #{remark},
            update_by = #{updateBy},
            update_time = sysdate()
        WHERE member_id = #{memberId}
    </update>

    <!-- 查询所有活跃会员 -->
    <select id="selectActiveMembers" resultMap="MemberResult">
        SELECT * FROM mall_member 
        WHERE status = '0' 
        ORDER BY member_id ASC
    </select>

    <!-- 根据用户名搜索会员 -->
    <select id="searchMembersByUsername" parameterType="String" resultMap="MemberResult">
        SELECT member_id, username, tg_username, source_type, status, linked_account
        FROM mall_member 
        WHERE username LIKE CONCAT('%', #{username}, '%')
        AND status != 1
        ORDER BY username
        LIMIT 10
    </select>

    <!-- 更新关联账号 -->
    <update id="updateLinkedAccount" parameterType="map">
        UPDATE mall_member
        SET linked_account = #{linkedAccountId},
            update_by = #{updateBy},
            update_time = sysdate()
        WHERE member_id = #{memberId}
    </update>

    <!-- 删除关联账号 -->
    <update id="removeLinkedAccount" parameterType="Long">
        UPDATE mall_member
        SET linked_account = NULL,
            update_time = sysdate()
        WHERE member_id = #{memberId}
    </update>

    <!-- 根据关联账号ID查询会员 -->
    <select id="selectMemberByLinkedAccount" parameterType="Long" resultMap="MemberResult">
        SELECT member_id, username, tg_username, source_type, status, linked_account
        FROM mall_member 
        WHERE linked_account = #{linkedAccountId}
        AND status != 1
    </select>

    <!-- 根据会员ID查询会员基本信息 -->
    <select id="selectMemberByMemberId" parameterType="Long" resultMap="MemberResult">
        SELECT member_id, username, tg_username, source_type, status, linked_account
        FROM mall_member 
        WHERE member_id = #{memberId}
        AND status != 1
    </select>

</mapper>